<script lang="ts" setup>
import { computed } from "vue";
import useMapStore from "@/stores/mapStore";
import { CityName, cities } from "@/assets/ts/constants";
import LanguageSwitcher from "./LanguageSwitcher.vue";

const mapStore = useMapStore();
const map = mapStore.map;
// Cities and topics for dropdowns
const cityOptions = computed(() =>
  cities.map((city) => ({
    name: city.name,
    latLng: city.latLng,
    isDisabled: !(city.name === CityName.KRYVYIRIH || city.name === CityName.NIKOPOL),
    isSelected: mapStore.city === city.name,
  })),
);
// Handle City Change
const handleCityChange = (e: Event) => {
  const target = e.target as HTMLSelectElement;
  const selectedCityName = target.value;
  const city = cities.find((c) => c.name === selectedCityName);

  if (city) {
    map.flyTo(city.latLng, 12);
    mapStore.setCity(city.name);
  }
};
</script>
<template>
  <div class="leaflet-sidebar-pane" id="vulnerability">
    <h1 class="leaflet-sidebar-header">
      {{ $t("sidebar.vulnerabilityPanel.header") }}
      <span class="leaflet-sidebar-close"><i class="fa fa-caret-right"></i></span>
    </h1>
    <language-switcher></language-switcher>
    <div class="sidebar-content">
      <ul class="list-unstyled ps-0">
        <li class="mb-1">
          <h6 class="text-uppercase">
            {{ $t("sidebar.vulnerabilityPanel.definition.header") }}
          </h6>
          <p class="sidebar-content-text text-uppercase fw-medium">
            {{ $t("sidebar.vulnerabilityPanel.definition.subtitle") }}
          </p>
          <p class="sidebar-content-text">
            {{ $t("sidebar.vulnerabilityPanel.definition.text") }}
          </p>
        </li>
        <li class="mb-1">
          <button
            class="btn btn-toggle rounded ps-0"
            data-bs-toggle="collapse"
            data-bs-target="#nationwide-layer-switch"
            aria-expanded="true"
          >
            {{ $t("sidebar.vulnerabilityPanel.layer") }}
          </button>
          <div class="collapse show" id="nationwide-layer-switch">
            <ul class="list-unstyled ps-0">
              <!-- initial presence layer -->
              <li class="mb-1 form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  :id="mapStore.boundaryLayer.name"
                  :name="mapStore.boundaryLayer.name"
                  v-model="mapStore.boundaryLayer.visible"
                />
                <label class="form-check-label" :for="mapStore.boundaryLayer.name">
                  {{ $t("layerNames." + mapStore.boundaryLayer.name) }}
                </label>
              </li>
              <li class="mb-1 form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="vulnerabilityLayer"
                  :name="mapStore.vulnerabilityLayer.name"
                  v-model="mapStore.vulnerabilityLayer.visible"
                />
                <label class="form-check-label" for="vulnerabilityLayer">{{
                  $t("layerNames." + mapStore.vulnerabilityLayer.name)
                }}</label>
              </li>
              <div class="form-floating mt-1">
                <label for="vulnerable-property-select">
                  {{ $t("sidebar.vulnerabilityPanel.propertySelector.selectLabel") }}
                </label>
                <select
                  id="vulnerable-property-select"
                  class="form-select form-select-sm rounded"
                  v-model="mapStore.selectedVulnerableProperty"
                >
                  <option
                    v-for="(value, key) in mapStore.geojsonData.vulnerabilityPoint
                      .properties"
                    :key="key"
                    :value="key"
                  >
                    {{
                      $t("sidebar.vulnerabilityPanel.propertySelector.properties." + key)
                    }}
                  </option>
                </select>
              </div>
            </ul>
          </div>
        </li>
        <li class="mb-1">
          <button
            class="btn btn-toggle rounded ps-0"
            data-bs-toggle="collapse"
            data-bs-target="#city-selector"
            aria-expanded="true"
          >
            {{ $t("sidebar.vulnerabilityPanel.citySelection.title") }}
          </button>
          <div class="collapse show" id="city-selector">
            <p class="sidebar-content-text fw-medium">
              {{ $t("sidebar.vulnerabilityPanel.citySelection.text") }}
            </p>
            <div class="form-group">
              <select
                id="city-select"
                class="form-select"
                @change="handleCityChange"
                aria-label="Select a city"
              >
                <option value="" disabled selected>
                  {{ $t("sidebar.settingsPanel.step1.selectDefault") }}
                </option>
                <option
                  v-for="city in cityOptions"
                  :key="city.name"
                  :value="city.name"
                  :disabled="city.isDisabled"
                  :selected="city.isSelected"
                >
                  {{ $t("cityNames." + city.name) }}
                </option>
              </select>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</template>
<style scoped>
.form-floating label {
  font-size: 0.75rem;
  color: rgba(0, 0, 0, 0.6);
  padding: 0.375rem 0 0 0.375rem;
}
</style>
